{% extends 'base.html' %}

{% block container %}
<div class="container-fluid">
  <div class="card shadow-sm">
    <div class="card-header">
      <h4>{{ title }}</h4>
    </div>
    <div class="card-body">
      <h5 class="card-title">Each bar represents a topic. Click one to get more details</h5>
      <div class="card-text">
        <canvas id="topic-weights" style="height: {{ num_topics * 32 }}px !important"></canvas>
      </div>
    </div>
  </div>
</div>
</body>
<script>
  var ctx = document.getElementById('topic-weights')
  var topicData = loadJSON("{{ url_for('static', filename = data_path + '/topic_cloud.json') }}", function(text) {
    var labels = []
    var weights = []
    var descriptions = []
    var topicData = JSON.parse(text).nodes;
    for (var i = 0; i < topicData.length; i += 1) {
      labels.push("Topic " + topicData[i].name)
      weights.push(topicData[i].frequency)
      descriptions.push(topicData[i].description)
    }
    Chart.defaults.global.responsive = true;
    Chart.defaults.global.animation.duration = 400;
    Chart.defaults.global.tooltipCornerRadius = 0;
    Chart.defaults.bar.scales.xAxes[0].gridLines.display = false;
    Chart.defaults.global.tooltips.enabled = false
    Chart.defaults.global.defaultFontSize = "16"
    var myChart = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels: labels,
        datasets: [{
          label: "topics",
          data: weights,
          backgroundColor: "rgba(85,172,238, .4)",
          borderWidth: 25
        }],
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          yAxes: [{
            id: 'topics',
            // type: 'category',
            // display: false,
            categoryPercentage: 1.0,
            barPercentage: 1.0,
            barThickness: 25,
            gridLines: {
              display: false,
              offsetGridLines: false
            },
            // stacked: true
          }],
          xAxes: [{
            // stacked: true,
            display: false
          }]
        },
        legend: {
          display: false
        },
        hover: {
          animationDuration: 0
        },
        animation: {
          duration: 1,
          onComplete() {
            const chartInstance = this.chart;
            const ctx2 = chartInstance.ctx;
            const dataset = this.data.datasets[0];
            const meta = chartInstance.controller.getDatasetMeta(0);

            Chart.helpers.each(meta.data.forEach((bar, index) => {
              const label = descriptions[index];
              const labelPositionX = 90;
              const labelWidth = ctx2.measureText(label).width + labelPositionX;

              ctx2.textBaseline = 'middle';
              ctx2.textAlign = 'left';
              ctx2.fillStyle = '#444';
              ctx2.fillText(label, labelPositionX, bar._model.y);
            }));
          }
        }
      }
    });
    // ctx.style.height = labels.length * 140
    // ctx.style.backgroundColor = 'rgba(85,172,238, .2)';
    ctx.addEventListener('click', function(e) {
      let target = myChart.getElementAtEvent(e)
      if (typeof(target[0]) !== 'undefined') {
        let topic = target[0]._view.label.replace("Topic ", "")
        window.location.href = "../topic/" + topic + ".html"
      }
    }, false);
  })
</script>
{% endblock %}